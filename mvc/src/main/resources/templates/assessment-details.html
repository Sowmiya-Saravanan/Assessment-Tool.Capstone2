<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educator Dashboard - AssessCraft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c7873;
            --secondary-color: #52de97;
            --dark-color: #546e7a;
            --light-color: #f9f9f9;
            --highlight-color: #f7be16;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .sidebar {
            background: var(--primary-color);
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            padding-top: 20px;
        }
        .sidebar a {
            color: white;
            padding: 15px 20px;
            display: block;
            text-decoration: none;
        }
        .sidebar a:hover {
            background: var(--secondary-color);
        }
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .alert {
            border-radius: 8px;
        }
        .form-control {
            border-radius: 8px;
            border: 1px solid #dcdcdc;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(44, 120, 115, 0.3);
        }
        .modal-content {
            border-radius: 10px;
        }
        .modal-header {
            background: var(--primary-color);
            color: white;
        }
        .table th, .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 class="text-center">AssessCraft</h3>
        <a href="/educator/dashboard"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a>
        <a href="/educator/logout"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <div class="content">
        <h1 class="mb-4">Educator Dashboard</h1>

        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>

        <!-- Dashboard Summary -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                Dashboard Summary
            </div>
            <div class="card-body">
                <p th:if="${dashboardData}">
                    Total Classes: <span th:text="${dashboardData.totalClasses}"></span><br>
                    Total Assessments: <span th:text="${dashboardData.totalAssessments}"></span><br>
                    Total Students: <span th:text="${dashboardData.totalStudents}"></span>
                </p>
            </div>
        </div>

        <!-- Create Class Form -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                Create New Class
            </div>
            <div class="card-body">
                <form th:action="@{/educator/create-class}" th:object="${classEntity}" method="post">
                    <div class="mb-3">
                        <label for="className" class="form-label">Class Name</label>
                        <input type="text" class="form-control" id="className" th:field="*{className}" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" th:field="*{description}"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Class</button>
                </form>
            </div>
        </div>

        <!-- Drafted Classes -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                Drafted Classes
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Description</th>
                            <th>Class Code</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="class : ${draftedClasses}">
                            <td th:text="${class.className}"></td>
                            <td th:text="${class.description}"></td>
                            <td th:text="${class.classCode}"></td>
                            <td>
                                <button class="btn btn-sm btn-danger" th:onclick="'deleteClass(' + ${class.classId} + ')'">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Active Classes -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                Active Classes
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Description</th>
                            <th>Class Code</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="class : ${activeClasses}">
                            <td th:text="${class.className}"></td>
                            <td th:text="${class.description}"></td>
                            <td th:text="${class.classCode}"></td>
                            <td>
                                <button class="btn btn-sm btn-primary" th:onclick="'openManageStudentsModal(' + ${class.classId} + ')'">Manage Students</button>
                                <button class="btn btn-sm btn-danger" th:onclick="'deleteClass(' + ${class.classId} + ')'">Delete</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Assessments -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                Assessments
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createAssessmentModal">Create Assessment</button>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="assessment : ${assessments}">
                            <td th:text="${assessment.title}"></td>
                            <td th:text="${assessment.type}"></td>
                            <td th:text="${assessment.status}"></td>
                            <td>
                                <a th:href="@{/educator/assessment/{id}(id=${assessment.assessmentId})}" class="btn btn-sm btn-info">View</a>
                                <button class="btn btn-sm btn-danger" th:onclick="'deleteAssessment(' + ${assessment.assessmentId} + ')'">Delete</button>
                                <button class="btn btn-sm btn-primary" th:onclick="'openAssignAssessmentModal(' + ${assessment.assessmentId} + ')'">Assign to Class</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create Assessment Modal -->
        <div class="modal fade" id="createAssessmentModal" tabindex="-1" aria-labelledby="createAssessmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createAssessmentModalLabel">Create New Assessment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form th:action="@{/educator/assessment/create}" th:object="${assessment}" method="post">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" th:field="*{title}" required>
                                <div th:errors="*{title}" class="text-danger"></div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" th:field="*{description}"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="type" class="form-label">Type</label>
                                <select class="form-control" id="type" th:field="*{type}" required>
                                    <option value="QUIZ">Quiz</option>
                                    <option value="TEST">Test</option>
                                </select>
                                <div th:errors="*{type}" class="text-danger"></div>
                            </div>
                            <div class="mb-3">
                                <label for="classId" class="form-label">Assign to Class (Optional)</label>
                                <select class="form-control" id="classId" name="classId">
                                    <option value="">None</option>
                                    <option th:each="class : ${classes}" th:value="${class.classId}" th:text="${class.className}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="durationMinutes" class="form-label">Duration (Minutes)</label>
                                <input type="number" class="form-control" id="durationMinutes" th:field="*{durationMinutes}" required>
                                <div th:errors="*{durationMinutes}" class="text-danger"></div>
                            </div>
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="datetime-local" class="form-control" id="startTime" th:field="*{startTime}" required>
                                <div th:errors="*{startTime}" class="text-danger"></div>
                            </div>
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="datetime-local" class="form-control" id="endTime" th:field="*{endTime}" required>
                                <div th:errors="*{endTime}" class="text-danger"></div>
                            </div>
                            <div class="mb-3">
                                <label for="gradingMode" class="form-label">Grading Mode</label>
                                <select class="form-control" id="gradingMode" th:field="*{gradingMode}" required>
                                    <option value="AUTOMATIC">Automatic</option>
                                    <option value="MANUAL">Manual</option>
                                </select>
                                <div th:errors="*{gradingMode}" class="text-danger"></div>
                            </div>
                            <!-- Simplified: Questions can be added in a separate step or via API -->
                            <button type="submit" class="btn btn-primary">Create Assessment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assign Assessment to Class Modal -->
        <div class="modal fade" id="assignAssessmentModal" tabindex="-1" aria-labelledby="assignAssessmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="assignAssessmentModalLabel">Assign Assessment to Class</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="assignAssessmentForm">
                            <div class="mb-3">
                                <label for="assignClassId" class="form-label">Select Class</label>
                                <select class="form-control" id="assignClassId" name="classId" required>
                                    <option th:each="class : ${classes}" th:value="${class.classId}" th:text="${class.className}"></option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Assign</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Students Modal -->
        <div class="modal fade" id="manageStudentsModal" tabindex="-1" aria-labelledby="manageStudentsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="manageStudentsModalLabel">Manage Students</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6>Add Student by Email</h6>
                            <form id="addStudentForm" class="row g-3">
                                <div class="col-auto">
                                    <input type="email" class="form-control" id="studentEmail" placeholder="Enter student email" required>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary">Add Student</button>
                                </div>
                            </form>
                        </div>
                        <div class="mb-3">
                            <h6>Bulk Add Students (CSV Upload)</h6>
                            <form id="bulkAddStudentsForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="bulkStudentsFile" name="file" accept=".csv" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Upload CSV</button>
                            </form>
                        </div>
                        <h6>Current Students</h6>
                        <table class="table table-bordered" id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <h6>Sent Invitations</h6>
                        <table class="table table-bordered" id="invitationsTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
        let currentClassId = null;

        function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class?')) {
                fetch(`/educator/class/${classId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to delete class');
                    }
                });
            }
        }

        function deleteAssessment(assessmentId) {
            if (confirm('Are you sure you want to delete this assessment?')) {
                fetch(`/educator/assessment/${assessmentId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to delete assessment');
                    }
                });
            }
        }

        function openManageStudentsModal(classId) {
            currentClassId = classId;
            document.getElementById('manageStudentsModalLabel').textContent = `Manage Students for Class ID: ${classId}`;
            fetchStudents(classId);
            fetchInvitations(classId);
            new bootstrap.Modal(document.getElementById('manageStudentsModal')).show();
        }

        function openAssignAssessmentModal(assessmentId) {
            const form = document.getElementById('assignAssessmentForm');
            form.action = `/educator/assessment/${assessmentId}/assign-to-class`;
            new bootstrap.Modal(document.getElementById('assignAssessmentModal')).show();
        }

        document.getElementById('addStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('studentEmail').value;
            fetch(`/educator/class/${currentClassId}/add-student`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            }).then(response => {
                if (response.ok) {
                    fetchStudents(currentClassId);
                    fetchInvitations(currentClassId);
                    document.getElementById('studentEmail').value = '';
                } else {
                    alert('Failed to add student');
                }
            });
        });

        document.getElementById('bulkAddStudentsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(`/educator/class/${currentClassId}/bulk-students`, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    fetchStudents(currentClassId);
                    fetchInvitations(currentClassId);
                    document.getElementById('bulkStudentsFile').value = '';
                } else {
                    alert('Failed to bulk add students');
                }
            });
        });

        function fetchStudents(classId) {
            fetch(`/educator/class/${classId}/students`)
                .then(response => response.json())
                .then(students => {
                    const tbody = document.querySelector('#studentsTable tbody');
                    tbody.innerHTML = '';
                    students.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.email}</td>
                            <td>${student.status}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="removeStudent('${student.email}')">Remove</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }

        function fetchInvitations(classId) {
            fetch(`/educator/dashboard/sent-invitations?classId=${classId}`)
                .then(response => response.json())
                .then(invitations => {
                    const tbody = document.querySelector('#invitationsTable tbody');
                    tbody.innerHTML = '';
                    invitations.forEach(invitation => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${invitation.email}</td>
                            <td>${invitation.status}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }

        function removeStudent(email) {
            fetch(`/educator/class/${currentClassId}/remove-student`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            }).then(response => {
                if (response.ok) {
                    fetchStudents(currentClassId);
                } else {
                    alert('Failed to remove student');
                }
            });
        }
    </script>
</body>
</html>